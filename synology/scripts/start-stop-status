#!/bin/sh

PKG_NAME="tricerapost"
PKG_DIR="${SYNOPKG_PKGDEST}"
PKG_VAR="/var/packages/${PKG_NAME}/var"
PID_FILE="${PKG_VAR}/tricerapost.pid"
LOG_FILE="${PKG_VAR}/tricerapost.log"
PYTHON_HOME="/volume1/@appstore/Python3.9/usr"
PYTHON_BIN="${PYTHON_HOME}/bin/python3.9"
if [ -x "${PYTHON_BIN}" ]; then
    export PYTHONHOME="${PYTHON_HOME}"
else
    PYTHON_BIN="/usr/bin/python3"
fi
APP_MAIN="${PKG_DIR}/app/gui/server.py"

export PYTHONPATH="${PKG_DIR}/app"
export TRICERAPOST_DB_IN_MEMORY="0"
export TRICERAPOST_DB_DIR="${PKG_VAR}/data"
export TRICERAPOST_SETTINGS_PATH="${PKG_VAR}/settings.json"
export TRICERAPOST_BIND_HOST="0.0.0.0"

start_daemon() {
    mkdir -p "${PKG_VAR}" "${PKG_VAR}/data"
    if [ -f "${PID_FILE}" ] && kill -0 "$(cat "${PID_FILE}")" 2>/dev/null; then
        return 0
    fi
    nohup "${PYTHON_BIN}" "${APP_MAIN}" >> "${LOG_FILE}" 2>&1 &
    echo $! > "${PID_FILE}"
    sleep 1
    if ! kill -0 "$(cat "${PID_FILE}")" 2>/dev/null; then
        return 1
    fi
}

stop_daemon() {
    if [ ! -f "${PID_FILE}" ]; then
        return 0
    fi
    pid="$(cat "${PID_FILE}")"
    if [ -n "${pid}" ] && kill -0 "${pid}" 2>/dev/null; then
        kill "${pid}"
        tries=0
        while kill -0 "${pid}" 2>/dev/null && [ "${tries}" -lt 10 ]; do
            sleep 1
            tries=$((tries + 1))
        done
        if kill -0 "${pid}" 2>/dev/null; then
            kill -9 "${pid}"
        fi
    fi
    rm -f "${PID_FILE}"
}

status_daemon() {
    if [ -f "${PID_FILE}" ] && kill -0 "$(cat "${PID_FILE}")" 2>/dev/null; then
        echo "${PKG_NAME} running"
        return 0
    fi
    echo "${PKG_NAME} stopped"
    return 1
}

case "$1" in
    start)
        start_daemon
        ;;
    stop)
        stop_daemon
        ;;
    restart)
        stop_daemon
        start_daemon
        ;;
    status)
        status_daemon
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
 esac

exit 0
